#!/bin/bash
set -euo pipefail

# YouTube Playlist MCP Server Installation
# Official YouTube MCP for accessing and editing Watch Later and user playlists
# Based on the dotfiles pattern established for Gmail MCP

DOTFILES_DIR="${DOTFILES_DIR:-$HOME/dotfiles}"
MCP_DIR="$HOME/.youtube-playlist-mcp"

echo "üîß Setting up YouTube Playlist MCP server..."

# Check if Node.js is available
if ! command -v node >/dev/null 2>&1; then
    echo "‚ùå Node.js is required but not installed. Please install Node.js 18+ first."
    exit 1
fi

# Check Node.js version
NODE_VERSION=$(node --version | sed 's/v//')
REQUIRED_VERSION="18.0.0"

if [ "$(printf '%s\n' "$REQUIRED_VERSION" "$NODE_VERSION" | sort -V | head -n1)" != "$REQUIRED_VERSION" ]; then
    echo "‚ùå Node.js version $NODE_VERSION is too old. Please upgrade to Node.js 18+."
    exit 1
fi

# Check if Git is available
if ! command -v git >/dev/null 2>&1; then
    echo "‚ùå Git is required but not installed. Please install Git first."
    exit 1
fi

# Create MCP directory
mkdir -p "$MCP_DIR"
cd "$MCP_DIR"

# Clone the official YouTube Playlist MCP repository
echo "üì¶ Cloning official YouTube Playlist MCP server..."
git clone https://github.com/adrianmacneil/youtube-mcp.git .

# Install dependencies
echo "üì¶ Installing npm dependencies..."
npm install

# Build the project
echo "üî® Building the project..."
npm run build

# Create package.json for tracking (preserve original but add metadata)
cat > package.json.bak << EOF
{
  "name": "youtube-playlist-mcp-server",
  "description": "Official YouTube MCP server for accessing and editing playlists (Watch Later, user playlists)",
  "repository": {
    "type": "git",
    "url": "https://github.com/adrianmacneil/youtube-mcp.git"
  },
  "dependencies": {
    "@modelcontextprotocol/sdk": "^0.5.0",
    "googleapis": "^144.0.0"
  },
  "scripts": {
    "build": "tsc",
    "start": "node dist/index.js"
  }
}
EOF

# Create OAuth credentials template
cat > oauth-setup.md << EOF
# YouTube Playlist MCP OAuth Setup

## Google Cloud Console Setup

1. Go to https://console.cloud.google.com/
2. Create a new project or select existing one
3. Enable YouTube Data API v3:
   - Go to "APIs & Services" > "Library"
   - Search for "YouTube Data API v3"
   - Click "Enable"
4. Create OAuth 2.0 credentials:
   - Go to "APIs & Services" > "Credentials"
   - Click "Create Credentials" > "OAuth 2.0 Client ID"
   - Application type: "Desktop app"
   - Download the credentials JSON file

## Setup Instructions

1. Save the credentials JSON file as: $MCP_DIR/credentials.json
2. Run: npm start (will prompt for authentication)
3. Authorize the application in your browser
4. The OAuth tokens will be saved automatically

## Required Scopes
- https://www.googleapis.com/auth/youtube.readonly
- https://www.googleapis.com/auth/youtube
EOF

echo "‚úÖ YouTube Playlist MCP server installed successfully!"
echo "üìÅ Location: $MCP_DIR"
echo ""
echo "Next steps:"
echo "1. Set up OAuth credentials (see oauth-setup.md)"
echo "2. Save credentials.json to $MCP_DIR/"
echo "3. Run: mcp integrate youtube-playlist"
echo "4. Restart Claude Desktop"
echo ""
echo "For usage details, see: $DOTFILES_DIR/youtube-playlist-mcp/doc/usage.md"
echo "For OAuth setup, see: $MCP_DIR/oauth-setup.md"