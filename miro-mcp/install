#!/bin/bash
set -euo pipefail

# Miro MCP Installation Script
# Installs the official Miro MCP server for Claude Code

MIRO_MCP_DIR="$HOME/.miro-mcp"
REPO_URL="https://github.com/evalstate/mcp-miro"

echo "🔧 Installing Miro MCP server..."

# Check if already installed
if [[ -d "$MIRO_MCP_DIR" ]]; then
    echo "⚠️  Miro MCP already exists at $MIRO_MCP_DIR"
    read -p "Remove and reinstall? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "$MIRO_MCP_DIR"
    else
        echo "Installation cancelled."
        exit 0
    fi
fi

# Clone the repository
echo "📥 Cloning Miro MCP server..."
git clone "$REPO_URL" "$MIRO_MCP_DIR"

# Navigate to the directory
cd "$MIRO_MCP_DIR"

# Install dependencies
echo "📦 Installing dependencies..."
npm install

# Build the project
echo "🔨 Building the project..."
npm run build

# Make the server executable
chmod +x build/index.js

# Create configuration directory
mkdir -p "$HOME/.config/miro-mcp"

# Set permissions for sensitive files (if any)
find "$MIRO_MCP_DIR" -name "*.env*" -exec chmod 600 {} \; 2>/dev/null || true

echo "✅ Miro MCP server installed successfully!"
echo ""
echo "Next steps:"
echo "1. Get your Miro API access token:"
echo "   - Go to https://miro.com/app/settings/user-profile/apps"
echo "   - Create a new app or use existing one"
echo "   - Generate an access token"
echo ""
echo "2. Add the MCP to Claude Code:"
echo "   claude mcp add-json '{\"miro\":{\"command\":\"node\",\"args\":[\"$MIRO_MCP_DIR/build/index.js\"],\"env\":{\"MIRO_ACCESS_TOKEN\":\"your-access-token\"}}}'"
echo ""
echo "3. Test the connection:"
echo "   claude mcp list"