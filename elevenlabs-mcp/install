#!/bin/bash
set -e

# ElevenLabs MCP Server Installation Script
# Uses uv for Python package management

DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
MCP_DIR="$HOME/.elevenlabs-mcp"

echo "ðŸ”§ Installing ElevenLabs MCP server..."

# Create MCP directory
mkdir -p "$MCP_DIR"

# Clone the ElevenLabs MCP server repository
echo "ðŸ“¦ Cloning ElevenLabs MCP server..."
if [ -d "$MCP_DIR" ] && [ -f "$MCP_DIR/pyproject.toml" ]; then
    echo "Repository already exists, updating..."
    cd "$MCP_DIR"
    git pull origin main
else
    rm -rf "$MCP_DIR"
    git clone https://github.com/mamertofabian/elevenlabs-mcp-server.git "$MCP_DIR"
fi

# Install dependencies using uv
echo "ðŸ“‹ Installing dependencies with uv..."
cd "$MCP_DIR"

# Check if uv is available
if ! command -v uv &> /dev/null; then
    echo "Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
fi

# Sync dependencies
uv sync

# Set proper permissions for sensitive files
echo "ðŸ”’ Setting secure permissions..."
if [ -f ".env" ]; then
    chmod 600 .env
fi

# Create configuration template if it doesn't exist
if [ ! -f ".env.example" ] && [ ! -f ".env" ]; then
    cat > .env.example << 'EOF'
# ElevenLabs API Configuration
ELEVENLABS_API_KEY=your_elevenlabs_api_key_here
ELEVENLABS_VOICE_ID=your_default_voice_id_here
EOF
    echo "âš™ï¸  Created .env.example configuration template"
fi

echo "âœ… ElevenLabs MCP server installation complete!"
echo ""
echo "ðŸŽ¯ Next steps:"
echo "1. Get your ElevenLabs API key from: https://elevenlabs.io/app/settings/api-keys"
echo "2. Copy .env.example to .env and add your API key:"
echo "   cp ~/.elevenlabs-mcp/.env.example ~/.elevenlabs-mcp/.env"
echo "3. Edit the .env file and add your API key and voice ID"
echo "4. Run: mcp integrate elevenlabs"
