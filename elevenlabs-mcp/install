#!/bin/bash
set -e

# ElevenLabs MCP Server Installation Script
# Based on the pattern established by gmail-mcp

DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
MCP_DIR="$HOME/.elevenlabs-mcp"

echo "ðŸ”§ Installing ElevenLabs MCP server..."

# Create MCP directory
mkdir -p "$MCP_DIR"

# Clone the ElevenLabs MCP server repository
echo "ðŸ“¦ Cloning ElevenLabs MCP server..."
if [ -d "$MCP_DIR/elevenlabs-mcp" ]; then
    echo "Repository already exists, updating..."
    cd "$MCP_DIR/elevenlabs-mcp"
    git pull origin main
else
    git clone https://github.com/modelcontextprotocol/servers.git "$MCP_DIR/temp-servers"
    # Move the elevenlabs server to the correct location
    mv "$MCP_DIR/temp-servers/src/elevenlabs" "$MCP_DIR/elevenlabs-mcp"
    rm -rf "$MCP_DIR/temp-servers"
fi

# Install dependencies
echo "ðŸ“‹ Installing dependencies..."
cd "$MCP_DIR/elevenlabs-mcp"
if [ -f "package.json" ]; then
    npm install
elif [ -f "requirements.txt" ]; then
    pip install -r requirements.txt
fi

# Set proper permissions for sensitive files
echo "ðŸ”’ Setting secure permissions..."
if [ -f ".env" ]; then
    chmod 600 .env
fi

# Create configuration template if it doesn't exist
if [ ! -f ".env.example" ] && [ ! -f ".env" ]; then
    cat > .env.example << 'EOF'
# ElevenLabs API Configuration
ELEVENLABS_API_KEY=your_elevenlabs_api_key_here
ELEVENLABS_VOICE_ID=your_default_voice_id_here
EOF
    echo "âš™ï¸  Created .env.example configuration template"
fi

echo "âœ… ElevenLabs MCP server installation complete!"
echo ""
echo "ðŸŽ¯ Next steps:"
echo "1. Get your ElevenLabs API key from: https://elevenlabs.io/app/settings/api-keys"
echo "2. Copy .env.example to .env and add your API key:"
echo "   cp ~/.elevenlabs-mcp/elevenlabs-mcp/.env.example ~/.elevenlabs-mcp/elevenlabs-mcp/.env"
echo "3. Edit the .env file and add your API key and voice ID"
echo "4. Run: mcp integrate elevenlabs"