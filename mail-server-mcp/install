#!/bin/bash

# MCP Mail Server Installation Script
# Based on yunfeizhu/mcp-mail-server
# Supports project-based primary/secondary mail configuration

set -euo pipefail

MAIL_MCP_DIR="$HOME/.mail-server-mcp"
MAIL_MCP_REPO="https://github.com/yunfeizhu/mcp-mail-server.git"

echo "Installing MCP Mail Server (Single Instance + Project-based Config)..."

# Create directory if it doesn't exist
mkdir -p "$MAIL_MCP_DIR"

# Clone or update the repository
if [ -d "$MAIL_MCP_DIR/.git" ]; then
    echo "Updating existing MCP Mail Server..."
    cd "$MAIL_MCP_DIR"
    git pull
else
    echo "Cloning MCP Mail Server..."
    git clone "$MAIL_MCP_REPO" "$MAIL_MCP_DIR"
    cd "$MAIL_MCP_DIR"
fi

# Install dependencies
echo "Installing dependencies..."
npm install

# Build the project
echo "Building project..."
npm run build

# Create wrapper scripts for primary and secondary mail
echo "Creating wrapper scripts..."

# Primary mail wrapper
cat > "$MAIL_MCP_DIR/wrapper-primary" << 'EOF'
#!/bin/bash
# MCP Mail Server - Primary Mail Wrapper
# Maps PRIMARY_MAIL_* environment variables to standard EMAIL_* variables

# Check if PRIMARY_MAIL_* variables are set
if [ -z "${PRIMARY_MAIL_USER:-}" ]; then
    echo "ERROR: PRIMARY_MAIL_USER not set. Please define PRIMARY_MAIL_* variables in your project's .envrc" >&2
    exit 1
fi

# Map PRIMARY_MAIL_* to EMAIL_* variables expected by the MCP server
export EMAIL_USER="${PRIMARY_MAIL_USER}"
export EMAIL_PASS="${PRIMARY_MAIL_PASS}"
export IMAP_HOST="${PRIMARY_MAIL_IMAP_HOST}"
export IMAP_PORT="${PRIMARY_MAIL_IMAP_PORT:-993}"
export IMAP_SECURE="${PRIMARY_MAIL_IMAP_SECURE:-true}"
export SMTP_HOST="${PRIMARY_MAIL_SMTP_HOST}"
export SMTP_PORT="${PRIMARY_MAIL_SMTP_PORT:-465}"
export SMTP_SECURE="${PRIMARY_MAIL_SMTP_SECURE:-true}"
export DEBUG="${PRIMARY_MAIL_DEBUG:-false}"

# Execute the MCP server
exec node ~/.mail-server-mcp/dist/index.js
EOF

# Secondary mail wrapper  
cat > "$MAIL_MCP_DIR/wrapper-secondary" << 'EOF'
#!/bin/bash
# MCP Mail Server - Secondary Mail Wrapper
# Maps SECONDARY_MAIL_* environment variables to standard EMAIL_* variables

# Check if SECONDARY_MAIL_* variables are set
if [ -z "${SECONDARY_MAIL_USER:-}" ]; then
    echo "ERROR: SECONDARY_MAIL_USER not set. Please define SECONDARY_MAIL_* variables in your project's .envrc" >&2
    exit 1
fi

# Map SECONDARY_MAIL_* to EMAIL_* variables expected by the MCP server
export EMAIL_USER="${SECONDARY_MAIL_USER}"
export EMAIL_PASS="${SECONDARY_MAIL_PASS}"
export IMAP_HOST="${SECONDARY_MAIL_IMAP_HOST}"
export IMAP_PORT="${SECONDARY_MAIL_IMAP_PORT:-993}"
export IMAP_SECURE="${SECONDARY_MAIL_IMAP_SECURE:-true}"
export SMTP_HOST="${SECONDARY_MAIL_SMTP_HOST}"
export SMTP_PORT="${SECONDARY_MAIL_SMTP_PORT:-465}"
export SMTP_SECURE="${SECONDARY_MAIL_SMTP_SECURE:-true}"
export DEBUG="${SECONDARY_MAIL_DEBUG:-false}"

# Execute the MCP server
exec node ~/.mail-server-mcp/dist/index.js
EOF

# Make wrapper scripts executable
chmod +x "$MAIL_MCP_DIR/wrapper-primary"
chmod +x "$MAIL_MCP_DIR/wrapper-secondary"

# Create example project .envrc file
EXAMPLE_ENVRC="$MAIL_MCP_DIR/example-project.envrc"
cat > "$EXAMPLE_ENVRC" << 'EOF'
#!/bin/bash
# Example Project .envrc - Copy this to your project directories
# Define PRIMARY_MAIL_* and optionally SECONDARY_MAIL_* variables

# === PRIMARY MAIL (Required) ===
# This will be used by the "mail-primary" MCP server

# Gmail Example
export PRIMARY_MAIL_USER="primary@gmail.com"
export PRIMARY_MAIL_PASS="primary-app-password"
export PRIMARY_MAIL_IMAP_HOST="imap.gmail.com"
export PRIMARY_MAIL_IMAP_PORT="993"
export PRIMARY_MAIL_IMAP_SECURE="true"
export PRIMARY_MAIL_SMTP_HOST="smtp.gmail.com"
export PRIMARY_MAIL_SMTP_PORT="465"
export PRIMARY_MAIL_SMTP_SECURE="true"

# === SECONDARY MAIL (Optional) ===
# This will be used by the "mail-secondary" MCP server
# Uncomment and configure if you need a second email account

# export SECONDARY_MAIL_USER="secondary@company.com"
# export SECONDARY_MAIL_PASS="secondary-app-password"
# export SECONDARY_MAIL_IMAP_HOST="imap.company.com"
# export SECONDARY_MAIL_IMAP_PORT="993"
# export SECONDARY_MAIL_IMAP_SECURE="true"
# export SECONDARY_MAIL_SMTP_HOST="smtp.company.com"
# export SECONDARY_MAIL_SMTP_PORT="465"
# export SECONDARY_MAIL_SMTP_SECURE="true"

# === EMAIL PROVIDER EXAMPLES ===
#
# Outlook/Office365:
# export PRIMARY_MAIL_IMAP_HOST="outlook.office365.com"
# export PRIMARY_MAIL_SMTP_HOST="smtp-mail.outlook.com"
# export PRIMARY_MAIL_SMTP_PORT="587"
# export PRIMARY_MAIL_SMTP_SECURE="false"
#
# Yahoo Mail:
# export PRIMARY_MAIL_IMAP_HOST="imap.mail.yahoo.com"
# export PRIMARY_MAIL_SMTP_HOST="smtp.mail.yahoo.com"
#
# Custom/Corporate:
# export PRIMARY_MAIL_IMAP_HOST="mail.company.com"
# export PRIMARY_MAIL_SMTP_HOST="mail.company.com"
EOF

chmod 600 "$EXAMPLE_ENVRC"

echo "✓ Created wrapper scripts: wrapper-primary, wrapper-secondary"
echo "✓ Created example project configuration: example-project.envrc"

echo ""
echo "MCP Mail Server installed successfully!"
echo ""
echo "Next Steps:"
echo "1. Copy ~/.mail-server-mcp/example-project.envrc to your project directories as .envrc"
echo "2. Edit each project's .envrc with your email settings"
echo "3. Run 'direnv allow' in each project directory"
echo "4. For Gmail: Create App Passwords (not regular passwords)"
echo "5. Add MCP servers to Claude Code configuration"
echo ""
echo "Usage:"
echo "  • Primary mail: Uses PRIMARY_MAIL_* variables from current directory"
echo "  • Secondary mail: Uses SECONDARY_MAIL_* variables from current directory"
echo "  • Each project can define its own primary/secondary accounts"
echo ""
echo "See: ~/dotfiles/mail-server-mcp/doc/usage.md for detailed setup instructions"