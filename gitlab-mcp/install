#!/bin/bash

set -e

DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
MCP_DIR="$HOME/.gitlab-mcp"
REPO_URL="https://github.com/ericcurtin/gitlab-mcp.git"

echo "Installing GitLab MCP server..."

# Clone the repository
if [ -d "$MCP_DIR" ]; then
    echo "Updating existing GitLab MCP installation..."
    cd "$MCP_DIR"
    git pull origin main
else
    echo "Cloning GitLab MCP repository..."
    git clone "$REPO_URL" "$MCP_DIR"
    cd "$MCP_DIR"
fi

# Install dependencies
echo "Installing npm dependencies..."
npm install

# Make build script executable
chmod +x build.sh

# Build the server
echo "Building GitLab MCP server..."
./build.sh

# Set permissions for sensitive files
if [ -f ".env" ]; then
    chmod 600 .env
fi

# Create Claude configuration
echo "Creating Claude configuration..."
CONFIG_DIR="$HOME/.claude"
mkdir -p "$CONFIG_DIR"

# Add GitLab MCP to Claude configuration
claude mcp add-json gitlab-mcp "{
  \"mcpServers\": {
    \"gitlab-mcp\": {
      \"command\": \"node\",
      \"args\": [\"$MCP_DIR/dist/index.js\"],
      \"env\": {
        \"GITLAB_PERSONAL_ACCESS_TOKEN\": \"YOUR_GITLAB_TOKEN_HERE\",
        \"GITLAB_URL\": \"https://gitlab.com\"
      }
    }
  }
}"

echo "GitLab MCP server installation complete!"
echo ""
echo "Next steps:"
echo "1. Create a GitLab personal access token at: https://gitlab.com/-/profile/personal_access_tokens"
echo "2. Update your Claude configuration with your token:"
echo "   Edit ~/.claude/mcp.json and replace 'YOUR_GITLAB_TOKEN_HERE' with your actual token"
echo "3. If using self-hosted GitLab, update GITLAB_URL accordingly"
echo "4. Restart Claude Code to load the new MCP server"
echo ""
echo "Usage: claude mcp list - to verify GitLab MCP is loaded"