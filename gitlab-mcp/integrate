#!/bin/bash
set -euo pipefail

DOTFILES_DIR=${DOTFILES_DIR:-~/dotfiles}
echo "Integrating GitLab MCP..."

if [ -d "$HOME/.gitlab-mcp" ]; then
  config_json="{\"command\":\"node\",\"args\":[\"$HOME/.gitlab-mcp/dist/index.js\"],\"env\":{\"GITLAB_PERSONAL_ACCESS_TOKEN\":\"${GITLAB_PERSONAL_ACCESS_TOKEN:-}\",\"GITLAB_URL\":\"${GITLAB_URL:-https://gitlab.com}\"}}"
  echo "Adding GitLab MCP to Claude Code..."
  claude mcp add-json gitlab "$config_json" --scope user
  echo "âœ“ GitLab MCP integrated"
  echo "Note: Set GITLAB_PERSONAL_ACCESS_TOKEN and optionally GITLAB_URL"
  "$DOTFILES_DIR/bin/codex-mcp" upsert gitlab <<EOF
# Goose integration
"$DOTFILES_DIR/goose/integrate" upsert-stdio gitlab node "$HOME/.gitlab-mcp/dist/index.js" --env-key GITLAB_PERSONAL_ACCESS_TOKEN
[mcp.servers.gitlab]
command = "node"
args = ["$HOME/.gitlab-mcp/dist/index.js"]
EOF
else
  echo "Error: GitLab MCP not installed. Run: mcp install gitlab" >&2
  exit 1
fi
