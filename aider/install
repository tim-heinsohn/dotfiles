#!/bin/bash

# NOTE: Aider only supports Python up to 3.13 by now due to distutils issue
# <https://github.com/Aider-AI/aider/issues/1984>

# Set strict error handling
set -euo pipefail

AIDER_VENV_PATH="$HOME/.aider-venv"
AIDER_BINARY="$HOME/.local/bin/aider"

echo "=== Aider Installation Script ==="

# Function to check if aider is already installed and working
check_aider_installation() {
    if [[ -x "$AIDER_BINARY" ]] && "$AIDER_BINARY" --version >/dev/null 2>&1; then
        echo "✓ Aider is already installed and working"
        "$AIDER_BINARY" --version
        return 0
    fi
    return 1
}

# Function to check if virtual environment exists and is valid
check_venv() {
    if [[ -d "$AIDER_VENV_PATH" ]] && [[ -x "$AIDER_VENV_PATH/bin/python" ]]; then
        echo "✓ Virtual environment already exists at $AIDER_VENV_PATH"
        return 0
    fi
    return 1
}

# Function to check if playwright is installed
check_playwright() {
    if "$AIDER_VENV_PATH/bin/python" -c "import playwright" >/dev/null 2>&1; then
        echo "✓ Playwright is already installed"
        return 0
    fi
    return 1
}

# Install Aider with uv
echo "Installing aider-chat..."
if uv tool install --python python3.12 --force aider-chat; then
    echo "✓ Aider tool installation completed"
else
    echo "✗ Failed to install aider-chat"
    exit 1
fi

# Create virtual environment if it doesn't exist
if ! check_venv; then
    echo "Creating virtual environment..."
    if uv venv --python python3.12 "$AIDER_VENV_PATH"; then
        echo "✓ Virtual environment created successfully"
    else
        echo "✗ Failed to create virtual environment"
        exit 1
    fi
else
    echo "Skipping virtual environment creation (already exists)"
fi

# Install additional dependencies
echo "Installing dependencies..."
if source "$AIDER_VENV_PATH/bin/activate" && \
   uv pip install aider-chat[help,playwright] boto3; then
    echo "✓ Dependencies installed successfully"
    deactivate
else
    echo "✗ Failed to install dependencies"
    exit 1
fi

# Install Playwright browsers if not already installed
if ! check_playwright; then
    echo "Installing Playwright browsers..."
    if "$AIDER_VENV_PATH/bin/python" -m playwright install --with-deps chromium; then
        echo "✓ Playwright browsers installed successfully"
    else
        echo "✗ Failed to install Playwright browsers"
        exit 1
    fi
else
    echo "Skipping Playwright installation (already installed)"
fi

# Verify installation
echo "Verifying installation..."
if check_aider_installation; then
    echo "✓ Aider installation verification successful"
    echo "=== Installation Complete ==="
else
    echo "✗ Aider installation verification failed"
    exit 1
fi