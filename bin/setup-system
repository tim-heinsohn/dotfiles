#!/bin/bash

DOTFILES_REPO=${DOTFILES_REPO:-https://github.com/tim-heinsohn/dotfiles.git}
DOTFILES_DIR=${DOTFILES_DIR:-~/dotfiles}

ensure_dotfiles_repo() {
    if [ -d "${DOTFILES_DIR}/.git" ]; then
        if ! git -C "${DOTFILES_DIR}" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
            echo "Error: ${DOTFILES_DIR} exists but is not a valid Git repository." >&2
            echo "Remove or move it, or set DOTFILES_DIR to a different path before rerunning." >&2
            return 1
        fi

        local current_branch
        current_branch=$(git -C "${DOTFILES_DIR}" rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
        if git -C "${DOTFILES_DIR}" rev-parse --abbrev-ref --symbolic-full-name "@{u}" >/dev/null 2>&1; then
            echo "Updating dotfiles repository on branch ${current_branch}..."
            git -C "${DOTFILES_DIR}" pull --ff-only
        else
            echo "Dotfiles repository already present at ${DOTFILES_DIR}." >&2
            echo "Current branch '${current_branch}' has no upstream; skipping git pull." >&2
            echo "Set a tracking branch (git branch --set-upstream-to origin/<branch>) if you want automatic pulls." >&2
        fi
    elif [ -e "${DOTFILES_DIR}" ]; then
        echo "Error: ${DOTFILES_DIR} exists but is not a Git repository (and is not empty)." >&2
        echo "Move it out of the way or set DOTFILES_DIR to a new location, then rerun." >&2
        return 1
    else
        git clone "${DOTFILES_REPO}" "${DOTFILES_DIR}"
    fi
}

print_help() {
    cat <<'EOF'
Usage: setup-system [-h|--help]

Provisions an Arch system with this dotfiles repo, installs core packages,
configures services, and links Bombadil-managed files.

Environment variables:
  DOTFILES_REPO   Source Git repository (default: https://github.com/tim-heinsohn/dotfiles.git)
  DOTFILES_DIR    Destination directory for the clone (default: ~/dotfiles)

Run the script without arguments after ensuring sudo access.
EOF
}

if [[ $# -gt 0 ]]; then
    case "$1" in
        -h|--help)
            print_help
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            print_help >&2
            exit 1
            ;;
    esac
fi

sudo pacman -Suy --needed --noconfirm git &&
# Restart gpg daemons to use updated versions after system update
gpgconf --kill all 2>/dev/null || true &&
ensure_dotfiles_repo &&
ln -sf "${DOTFILES_DIR}/bombadil.toml" "$HOME/.config/bombadil.toml" &&
cd "${DOTFILES_DIR}" &&
"${DOTFILES_DIR}/bin/setup-wallpapers" &&
"${DOTFILES_DIR}/aider/install" &&
"${DOTFILES_DIR}/aur/yay-install" &&
"${DOTFILES_DIR}/bin/packages-install" &&
"${DOTFILES_DIR}/docker/docker-group-setup" &&
"${DOTFILES_DIR}/ruby/rvm-setup" &&
"${DOTFILES_DIR}/whisper/setup" &&
bombadil link &&
sheldeon lock &&

yay -S --needed --noconfirm nvm
[ -s "/usr/share/nvm/init-nvm.sh" ] && source /usr/share/nvm/init-nvm.sh
nvm install 24.4.0
nvm alias default 24.4.0

# Install/update npm packages
"${DOTFILES_DIR}/bin/npm-packages" auto &&

# Install MCP servers
"${DOTFILES_DIR}/bin/mcp-install" install gmail playwright &&

# Setup Git service CLIs
"${DOTFILES_DIR}/bin/git-cli-setup" &&

# Setup Epson V330 scanner (if connected)
if lsusb | grep -q "04b8:0142"; then
    "${DOTFILES_DIR}/bin/scanner/setup-epson-v330"
fi &&

# overcommit
gem list overcommit -i >/dev/null 2>&1 || gem install overcommit &&

# terraform-ls
"${DOTFILES_DIR}/terraform-ls/install" &&

# add user to wheel group to get sudo privileges granted, e. g. for journalctl
# NOTE: requires "%wheel ALL=(ALL) ALL" in visudo
sudo usermod -aG wheel "$USER" &&

# add user to video group to allow adjusting brightness w/o sudo
sudo usermod -aG video "$USER" &&

# add user to audio group for microphone access
sudo usermod -aG audio "$USER" &&

# run acpi_listen after enabling this and press brightness keys on keyboard,
# e.g. Fn+F5/F6
sudo systemctl enable --now acpid &&
sudo systemctl enable --now bluetooth &&
sudo systemctl enable --now docker &&
# sudo systemctl enable --now qotd &&

# Setup disk health monitoring
"${DOTFILES_DIR}/bin/disk-health-setup" --install &&

# Switch to Java 17 for unciv compatibility (Java 25 causes build failures)
sudo archlinux-java set java-17-openjdk &&

sudo paccache -rk1 &&

echo "Done."
