#!/bin/bash
# @description Pre-link hooks - runs before bombadil link to prepare directories

print_help() {
    cat <<'EOF'
Usage: prehooks

Runs before bombadil link to prepare directories and clean up temporary files:
- Creates necessary ~/.config/ subdirectories
- Creates ~/.gnupg/ and ~/.zsh/ directories
- Installs pinentry wrapper if needed (requires sudo)
- Clears claude-code agent/command/docs directories

This script is called automatically by bombadil.
EOF
}

case "$1" in
    -h|--help)
        print_help
        exit 0
        ;;
esac

cd ~/.config && mkdir -p \
  alacritty \
  acpi/events \
  flameshot \
  i3status \
  nvim/lua \
  rofi \
  rofi-pass \
  sheldon \

mkdir -p \
  ~/.gnupg \
  ~/.zsh

# Install pinentry wrapper if changed (skip if not interactive)
WRAPPER_SOURCE="$HOME/dotfiles/gpg/pinentry-wrapper"
WRAPPER_TARGET="/usr/local/bin/pinentry-wrapper"

if [ -f "$WRAPPER_SOURCE" ]; then
  # Check if target differs (read access usually allowed)
  if ! cmp -s "$WRAPPER_SOURCE" "$WRAPPER_TARGET" 2>/dev/null; then
    # Try passwordless/cached sudo first
    if sudo -n true 2>/dev/null; then
      echo "Updating pinentry wrapper (cached sudo)"
      sudo cp "$WRAPPER_SOURCE" "$WRAPPER_TARGET"
      sudo chmod +x "$WRAPPER_TARGET"
    elif [ -t 0 ]; then
      # Interactive: try prompting
      echo "Updating pinentry wrapper (sudo may prompt)"
      sudo cp "$WRAPPER_SOURCE" "$WRAPPER_TARGET"
      sudo chmod +x "$WRAPPER_TARGET"
    else
      echo "Skipping pinentry wrapper update (sudo required, non-interactive)"
    fi
  fi
fi

rm -rf ~/dotfiles/.dots/claude-code/agents/*
rm -rf ~/dotfiles/.dots/claude-code/commands/*
rm -rf ~/dotfiles/.dots/claude-code/docs/*
