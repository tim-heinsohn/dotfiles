#!/bin/bash

# npm-packages - Install and update global npm packages
# Usage: ./npm-packages [install|update]

set -euo pipefail

OPENSPEC_PACKAGE="@fission-ai/openspec"
OPENSPEC_SUPERSKILLS_REPO="$HOME/superskills"

# List of global npm packages to manage
declare -a NPM_PACKAGES=(
    "@ansible/ansible-language-server"
    "@anthropic-ai/claude-code"
    "@atlaskit/editor-markdown-transformer"
    "@fission-ai/openspec@latest"
    "@google/gemini-cli"
    "@mermaid-js/mermaid-cli"
    "@microsoft/compose-language-service"
    "@openai/codex"
    "@spotlightjs/spotlight"
    "@usebruno/cli"
    "agent-browser"
    "bash-language-server"
    "backlog.md"
    "codebuff"
    "dockerfile-language-server-nodejs"
    "happy-coder"
    "markmap-cli"
    "opencode-ai"
    "pyright"
    "vscode-langservers-extracted"
)

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

get_global_npm_package_version() {
    local package="$1"

    npm list -g "$package" --depth=0 --json 2>/dev/null | node -e '
const pkg = process.argv[1];
let input = "";
process.stdin.on("data", (chunk) => input += chunk);
process.stdin.on("end", () => {
  try {
    const json = JSON.parse(input || "{}");
    const dep = (json.dependencies || {})[pkg];
    if (dep && dep.version) {
      process.stdout.write(dep.version);
    }
  } catch (_) {}
});
' "$package" || true
}

run_openspec_update_if_needed() {
    local before_version="$1"
    local after_version="$2"

    if [ "$before_version" = "$after_version" ]; then
        log "openspec unchanged ($after_version); skipping 'openspec update'"
        return 0
    fi

    if [ ! -d "$OPENSPEC_SUPERSKILLS_REPO/.git" ]; then
        log "superskills repo not found at $OPENSPEC_SUPERSKILLS_REPO; skipping 'openspec update'"
        return 0
    fi

    if ! command -v openspec >/dev/null 2>&1; then
        log "openspec command not found; skipping 'openspec update'"
        return 0
    fi

    log "openspec changed ($before_version -> $after_version); running 'openspec update' in $OPENSPEC_SUPERSKILLS_REPO"
    pushd "$OPENSPEC_SUPERSKILLS_REPO" >/dev/null || {
        log "Unable to enter $OPENSPEC_SUPERSKILLS_REPO; skipping 'openspec update'"
        return 0
    }

    if openspec update; then
        log "✓ Successfully ran 'openspec update' in $OPENSPEC_SUPERSKILLS_REPO"
    else
        log "⚠ 'openspec update' failed in $OPENSPEC_SUPERSKILLS_REPO"
    fi

    popd >/dev/null
}

check_npm() {
    if ! command -v npm >/dev/null 2>&1; then
        log "ERROR: npm is not installed or not in PATH"
        exit 1
    fi
}

check_nvm_node() {
    # Source nvm if available
    if [ -s "/usr/share/nvm/init-nvm.sh" ]; then
        source /usr/share/nvm/init-nvm.sh
    fi

    # Check if node is available
    if ! command -v node >/dev/null 2>&1; then
        log "ERROR: Node.js is not installed or not in PATH"
        log "Make sure to install nvm and set up Node.js first"
        exit 1
    fi
}

cleanup_stale_npm_dirs() {
    local package="$1"
    local root
    if ! root="$(npm root -g 2>/dev/null)"; then
        log "⚠ Unable to determine npm root; skipping cleanup for $package"
        return
    fi

    local pattern install_dir
    if [[ "$package" == @*/* ]]; then
        local scope="${package%%/*}"
        local name="${package#*/}"
        pattern="$root/$scope/.${name}-*"
        install_dir="$root/$scope/$name"
    else
        pattern="$root/.${package}-*"
        install_dir="$root/$package"
    fi

    shopt -s nullglob 2>/dev/null || true
    for dir in $pattern; do
        log "Removing stale npm temp directory $dir"
        rm -rf "$dir" || log "⚠ Failed to remove $dir"
    done
    shopt -u nullglob 2>/dev/null || true

    printf '%s\n' "$install_dir"
}

retry_clean_install() {
    local package="$1"
    local install_dir
    install_dir="$(cleanup_stale_npm_dirs "$package")"

    if [ -n "$install_dir" ] && [ -d "$install_dir" ]; then
        log "Removing existing $package directory for clean reinstall"
        rm -rf "$install_dir" || log "⚠ Failed to remove $install_dir"
    fi

    if npm install -g "$package"; then
        log "✓ Successfully reinstalled $package after cleanup"
    else
        log "✗ Clean reinstall of $package failed"
    fi
}

install_packages() {
    log "Installing global npm packages..."

    for package in "${NPM_PACKAGES[@]}"; do
        log "Installing $package..."
        cleanup_stale_npm_dirs "$package" >/dev/null
        if npm install -g "$package"; then
            log "✓ Successfully installed $package"
        else
            log "✗ Failed to install $package"
        fi
    done
}

update_packages() {
    log "Updating global npm packages..."

    for package in "${NPM_PACKAGES[@]}"; do
        log "Updating $package..."
        if npm list -g "$package" >/dev/null 2>&1; then
            cleanup_stale_npm_dirs "$package" >/dev/null
            if npm update -g "$package"; then
                log "✓ Successfully updated $package"
            else
                log "⚠ Update failed; retrying $package with clean reinstall"
                retry_clean_install "$package"
            fi
        else
            log "⚠ $package not installed, installing..."
            if npm install -g "$package"; then
                log "✓ Successfully installed $package"
            else
                log "✗ Failed to install $package"
            fi
        fi
    done
}

install_or_update_packages() {
    log "Installing/updating global npm packages..."

    for package in "${NPM_PACKAGES[@]}"; do
        if npm list -g "$package" >/dev/null 2>&1; then
            log "Updating $package..."
            cleanup_stale_npm_dirs "$package" >/dev/null
            if npm update -g "$package"; then
                log "✓ Successfully updated $package"
            else
                log "⚠ Update failed; retrying $package with clean reinstall"
                retry_clean_install "$package"
            fi
        else
            log "Installing $package..."
            cleanup_stale_npm_dirs "$package" >/dev/null
            if npm install -g "$package"; then
                log "✓ Successfully installed $package"
            else
                log "✗ Failed to install $package"
            fi
        fi
    done
}

install_opencode_smart_title_local() {
    local repo="/srv/lib/opencode-smart-title"
    local plugin_dir="$HOME/.config/opencode/plugins"
    local fork_url="https://github.com/tim-heinsohn/opencode-smart-title"

    # Clone repo if it doesn't exist
    if [ ! -d "$repo" ]; then
        log "opencode-smart-title repo not found at $repo; cloning from $fork_url"
        mkdir -p /srv/lib
        if git clone "$fork_url" "$repo"; then
            log "Cloned opencode-smart-title fork successfully"
        else
            log "⚠ git clone failed; skipping opencode-smart-title setup"
            return 0
        fi
    fi

    log "Setting up local opencode-smart-title from $repo"
    pushd "$repo" >/dev/null || { log "Unable to enter $repo"; return 0; }

    # Try to update repository to latest (optional if offline)
    if command -v git >/dev/null 2>&1; then
        if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
            # Ensure we're tracking the fork
            local current_remote
            current_remote="$(git remote get-url origin 2>/dev/null || echo '')"
            if [ "$current_remote" != "$fork_url" ]; then
                log "Updating remote to fork: $fork_url"
                git remote set-url origin "$fork_url" || log "⚠ Failed to update remote"
            fi

            if git rev-parse --abbrev-ref --symbolic-full-name "@{u}" >/dev/null 2>&1; then
                if git fetch --quiet; then
                    if git diff --quiet HEAD "@{u}"; then
                        log "opencode-smart-title repo is up to date"
                    elif git merge-base --is-ancestor HEAD "@{u}"; then
                        if git pull --ff-only; then
                            log "Pulled latest changes for opencode-smart-title"
                        else
                            log "⚠ git pull failed; continuing with current checkout"
                        fi
                    else
                        log "⚠ Local branch has diverged or is ahead; skipping git pull"
                    fi
                else
                    log "⚠ git fetch failed (likely no network); continuing"
                fi
            else
                log "⚠ Current branch has no upstream; skipping git pull"
            fi
        fi
    fi

    # Install dependencies
    if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
        if npm ci; then
            log "Dependencies installed for opencode-smart-title (npm ci)"
        else
            log "⚠ npm ci failed; skipping build"
            popd >/dev/null
            return 0
        fi
    else
        log "No lockfile found; using npm install instead of npm ci"
        if npm install; then
            log "Dependencies installed for opencode-smart-title (npm install)"
        else
            log "⚠ npm install failed; skipping build"
            popd >/dev/null
            return 0
        fi
    fi

    # Build plugin
    if npm run -s build; then
        log "opencode-smart-title built successfully"
    else
        log "⚠ opencode-smart-title build failed; skipping link"
        popd >/dev/null
        return 0
    fi

    # Symlink dist to OpenCode plugins directory
    mkdir -p "$plugin_dir"
    rm -rf "$plugin_dir/opencode-smart-title"
    ln -sf "$repo/dist" "$plugin_dir/opencode-smart-title"
    popd >/dev/null
    log "Linked $plugin_dir/opencode-smart-title -> $repo/dist"
}

show_usage() {
    echo "Usage: $0 [install|update|auto]"
    echo ""
    echo "Commands:"
    echo "  install  - Install all packages (skip if already installed)"
    echo "  update   - Update existing packages (install if missing)"
    echo "  auto     - Install missing packages, update existing ones (default)"
    echo ""
    echo "Managed packages:"
    for package in "${NPM_PACKAGES[@]}"; do
        echo "  - $package"
    done
    echo ""
    echo "Local packages built from source:"
    echo "  - opencode-smart-title (from /srv/lib/opencode-smart-title fork)"
}

main() {
    local command="${1:-auto}"
    local openspec_before_version=""
    local openspec_after_version=""

    case "$command" in
        install)
            check_npm
            check_nvm_node
            openspec_before_version="$(get_global_npm_package_version "$OPENSPEC_PACKAGE")"
            install_packages
            install_opencode_smart_title_local
            openspec_after_version="$(get_global_npm_package_version "$OPENSPEC_PACKAGE")"
            run_openspec_update_if_needed "$openspec_before_version" "$openspec_after_version"
            ;;
        update)
            check_npm
            check_nvm_node
            openspec_before_version="$(get_global_npm_package_version "$OPENSPEC_PACKAGE")"
            update_packages
            install_opencode_smart_title_local
            openspec_after_version="$(get_global_npm_package_version "$OPENSPEC_PACKAGE")"
            run_openspec_update_if_needed "$openspec_before_version" "$openspec_after_version"
            ;;
        auto)
            check_npm
            check_nvm_node
            openspec_before_version="$(get_global_npm_package_version "$OPENSPEC_PACKAGE")"
            install_or_update_packages
            install_opencode_smart_title_local
            openspec_after_version="$(get_global_npm_package_version "$OPENSPEC_PACKAGE")"
            run_openspec_update_if_needed "$openspec_before_version" "$openspec_after_version"
            ;;
        -h|--help|help)
            show_usage
            exit 0
            ;;
        *)
            log "ERROR: Unknown command '$command'"
            show_usage
            exit 1
            ;;
    esac

    log "npm packages management completed"
}

main "$@"
