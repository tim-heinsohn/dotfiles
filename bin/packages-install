#!/bin/bash
#
# packages-install: Install packages from the packages file
#
# Description:
# Reads package definitions from bin/packages and installs them
# using pacman (official) or yay (AUR). Separates AUR and official
# packages for optimal installation.

set -euo pipefail

# Get the directory where this script is located
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
packages_file="${script_dir}/packages"

# Track installation results
failed_packages=()
success_count=0

# Collect all packages first
all_packages=($(grep -E '^aur/|^core/|^extra/' "$packages_file" | cut -d' ' -f1))

echo "Installing ${#all_packages[@]} packages..."

# Update package databases once at the start
echo "Updating package databases..."
sudo pacman -Sy --noconfirm

# Separate AUR and official packages for batch installation
aur_packages=()
official_packages=()

for pkg in "${all_packages[@]}"; do
    repo="${pkg%%/*}"
    if [[ "$repo" == "aur" ]]; then
        aur_packages+=("$pkg")
    else
        official_packages+=("$pkg")
    fi
done

# Install official packages in batch
if [[ ${#official_packages[@]} -gt 0 ]]; then
    echo "Installing ${#official_packages[@]} official packages..."
    if sudo pacman -S --needed --noconfirm "${official_packages[@]}"; then
        success_count=$((success_count + ${#official_packages[@]}))
        echo "âœ“ Official packages installed successfully"
    else
        echo "âš  Some official packages failed to install"
        # Try installing official packages individually to identify failures
        for pkg in "${official_packages[@]}"; do
            if sudo pacman -S --needed --noconfirm "$pkg"; then
                success_count=$((success_count + 1))
            else
                failed_packages+=("$pkg")
            fi
        done
    fi
fi

# Package rename/replacement map: if the old package is installed and conflicts
# with the new one, remove it first before installing.
# Format: ["new/pkg"]="old-pkg-name"
declare -A package_replaces=(
    ["aur/antigravity"]="antigravity-bin"
)

# Install AUR packages individually (they can't be batched as easily)
if [[ ${#aur_packages[@]} -gt 0 ]]; then
    echo "Installing ${#aur_packages[@]} AUR packages..."
    for pkg in "${aur_packages[@]}"; do
        echo "Installing $pkg..."
        # Remove a conflicting predecessor package if present
        if [[ -n "${package_replaces[$pkg]:-}" ]]; then
            old_pkg="${package_replaces[$pkg]}"
            if pacman -Q "$old_pkg" &>/dev/null; then
                echo "Removing conflicting predecessor: $old_pkg..."
                sudo pacman -R --noconfirm "$old_pkg"
            fi
        fi
        if yay -S --needed --noconfirm "$pkg"; then
            success_count=$((success_count + 1))
            # After an Antigravity upgrade, wipe the stale Service Worker cache.
            # A version bump changes the service-worker.js query string, which
            # causes Chromium to fail re-registration with InvalidStateError on
            # the next launch if the old registration is still in the LevelDB.
            if [[ "$pkg" == "aur/antigravity" ]]; then
                sw_dir="${HOME}/.config/Antigravity/Service Worker"
                if [[ -d "$sw_dir" ]]; then
                    echo "Clearing Antigravity Service Worker cache after upgrade..."
                    rm -rf "$sw_dir/Database" "$sw_dir/ScriptCache"
                    echo "âœ“ Service Worker cache cleared"
                fi
            fi
        else
            failed_packages+=("$pkg")
            echo "âš  Failed to install $pkg"
        fi
    done
fi

# Report results
echo
echo "=== Installation Summary ==="
echo "âœ“ Successfully installed: $success_count packages"
if [[ ${#failed_packages[@]} -gt 0 ]]; then
    echo "âš  Failed to install: ${#failed_packages[@]} packages"
    echo "Failed packages:"
    printf "  - %s\n" "${failed_packages[@]}"
    echo
    echo "You can retry failed packages manually with:"
    echo "  yay -S ${failed_packages[*]}"
else
    echo "ðŸŽ‰ All packages installed successfully!"
fi
echo "Done."
