#!/usr/bin/env bash

# Context7 MCP Server Installation Script
# Based on the Gmail MCP installation pattern

set -e

DOTFILES_DIR="$HOME/dotfiles"
MCP_DIR="$HOME/.context7-mcp"
REPO_URL="https://github.com/upstash/context7"

echo "🚀 Installing Context7 MCP server..."

# Create MCP directory
mkdir -p "$MCP_DIR"

# Clone the repository
if [ ! -d "$MCP_DIR/.git" ]; then
    echo "📦 Cloning Context7 repository..."
    git clone "$REPO_URL" "$MCP_DIR"
else
    echo "🔄 Updating existing Context7 repository..."
    cd "$MCP_DIR"
    git pull origin main
fi

cd "$MCP_DIR"

# Install dependencies
echo "📋 Installing dependencies..."
if [ -f "package.json" ]; then
    npm install
elif [ -f "requirements.txt" ]; then
    uv pip install -r requirements.txt
elif [ -f "pyproject.toml" ]; then
    uv pip install .
else
    echo "⚠️  No dependency file found, skipping dependency installation"
fi

# Make any scripts executable
find "$MCP_DIR" -name "*.sh" -o -name "*.py" -o -name "*.js" | xargs chmod +x 2>/dev/null || true

# Set proper permissions for sensitive files
chmod 700 "$MCP_DIR"

# Create Claude MCP configuration
echo "🔧 Creating Claude MCP configuration..."
cat > "$MCP_DIR/mcp-config.json" << EOF
{
  "mcpServers": {
    "context7": {
      "command": "node",
      "args": ["$MCP_DIR/dist/index.js"],
      "env": {}
    }
  }
}
EOF

echo "✅ Context7 MCP server installed successfully!"
echo ""
echo "📖 Next steps:"
echo "1. Run 'claude mcp add-json $MCP_DIR/mcp-config.json' to add to Claude"
echo "2. Check '$MCP_DIR/README.md' for any additional setup requirements"
echo "3. Run 'claude mcp list' to verify the MCP is loaded"