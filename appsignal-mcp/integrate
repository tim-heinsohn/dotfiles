#!/bin/bash
set -e

DOTFILES_DIR=${DOTFILES_DIR:-~/dotfiles}
echo "üîß Integrating AppSignal MCP Server..."

# Check if Docker is available
if ! command -v docker &> /dev/null; then
    echo "‚ùå Error: Docker is required but not installed"
    echo "Please install Docker first: https://docs.docker.com/get-docker/"
    exit 1
fi

# Check if APPSIGNAL_API_KEY is set
if [ -z "${APPSIGNAL_API_KEY:-}" ]; then
    echo "‚ö†Ô∏è  Warning: APPSIGNAL_API_KEY environment variable is not set"
    echo ""
    echo "To get your AppSignal MCP token:"
    echo "1. Visit: https://appsignal.com/users/mcp_tokens (requires login)"
    echo "2. Set your token as an environment variable:"
    echo "   export APPSIGNAL_API_KEY='your-token-here'"
    echo ""
    echo "Would you like to continue integration and set the key later? (y/N)"
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Add to Claude Code
echo "Adding AppSignal MCP to Claude Code..."
claude mcp add appsignal -e APPSIGNAL_API_KEY=your_api_key_here -- docker run -i --rm -e APPSIGNAL_API_KEY appsignal/mcp


echo "‚úÖ AppSignal MCP integrated with Claude Code!"
echo ""
echo "üöÄ Next steps:"
if [ -z "${APPSIGNAL_API_KEY:-}" ]; then
    echo "1. Set your APPSIGNAL_API_KEY environment variable"
    echo "2. Restart Claude Code"
else
    echo "1. Restart Claude Code to use the AppSignal MCP"
fi
echo ""
echo "üìñ Documentation: $( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )/doc/usage.md"

# Codex: upsert into ~/.codex/config.toml
"$DOTFILES_DIR/bin/codex-mcp" upsert appsignal <<EOF
[mcp.servers.appsignal]
command = "docker"
args = ["run", "-i", "--rm", "-e", "APPSIGNAL_API_KEY", "appsignal/mcp"]
EOF

echo "‚úì AppSignal MCP added to Codex (~/.codex/config.toml)"
